---
title: "Data Cleaning - Mia"
author: "Mia Rothberg"
date: "11/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
```


```{r}
#data source: https://catalog.data.gov/dataset/asthma-deaths-by-county
asthma_deaths_CA <- read_csv("asthma_deaths.csv")

#data source: https://catalog.data.gov/dataset/asthma-emergency-department-visit-rates 
asthma_emergency_visits <- read_csv("asthma-emergency-department-visit-rates-by-county-2015_2019.csv")

#https://statecancerprofiles.cancer.gov/incidencerates/index.php?stateFIPS=06&areatype=county&cancer=055&race=00&sex=2&age=001&stage=999&year=0&type=incd&sortVariableName=rate&sortOrder=default&output=0#results
#not reading in right but the file looks fine
cancer <- read_csv("breast_cancer_women_5yravg_updated.csv")
```

```{r}
asthma_deaths_CA_clean <- asthma_deaths_CA %>% 
  mutate(YEARS = ifelse(str_detect(YEARS, "2014"), "2014.2016", "2017.2019")) %>% 
  filter(YEARS == "2017.2019",
         `AGE GROUP` == "All ages")

cancer_clean <- cancer %>% 
  mutate(County = ifelse(str_detect(County, "(7)"), substr(County, 1, nchar(County) - 3), County)) %>% 
  mutate(County = substr(County, 1, nchar(County) - 7)) %>% 
  mutate(County = ifelse(County == "Cal", "California", County))

asthma_er_clean <- asthma_emergency_visits %>% 
  select(-COMMENT) %>% 
  filter(YEAR > 2016) %>% 
  filter(`AGE GROUP` == "All ages") %>%
  filter(STRATA == "Total population") %>% 
  na.omit() %>% 
  group_by(COUNTY) %>% 
  summarize(asthma_er_avg = mean(`NUMBER OF ED VISITS`))
 
```

```{r}
illness_data <- cancer_clean %>% 
  left_join(asthma_deaths_CA_clean, by = c("County" = "COUNTY")) %>% 
  left_join(asthma_er_clean, by = c("County" = "COUNTY")) %>% 
  mutate(cancer_incidence_rate = `Age-Adjusted Incidence Rate([rate note]) - cases per 100,000`,
         asthma_deaths = `NUMBER OF DEATHS`) %>% 
  mutate(cancer_incidence_rate = as.numeric(cancer_incidence_rate)) %>% 
  select(County, FIPS, asthma_er_avg, cancer_incidence_rate, asthma_deaths)
```

```{r}
pm2017 <- read_csv("2017pm25.csv")
pm2018 <- read_csv("2018pm25.csv")
pm2019 <- read_csv("2019pm25.csv")

#modified to only have one value per county
pm25 <- rbind(pm2017, pm2018, pm2019) %>% 
  mutate(Year = substr(Date,nchar(Date)-3, nchar(Date))) %>% 
  group_by(COUNTY, Year) %>% 
  summarise(annual_mean_pm25 = mean(`Daily Mean PM2.5 Concentration`))
```

```{r}
co2017 <- read_csv("2017co.csv")
co2018 <- read_csv("2018co.csv")
co2019 <- read_csv("2019co.csv")

co <- rbind(co2017, co2018, co2019) %>% 
  mutate(Year = substr(Date,nchar(Date)-3, nchar(Date))) %>% 
  group_by(COUNTY, Year) %>% 
  summarise(annual_mean_co = mean(`Daily Max 8-hour CO Concentration`))
```

```{r}
pm2017 <- read_csv("2017pm10.csv")
pm2018 <- read_csv("2018pm10.csv")
pm2019 <- read_csv("2019pm10.csv")

pm10 <- rbind(pm2017, pm2018, pm2019) %>% 
  mutate(Year = substr(Date,nchar(Date)-3, nchar(Date))) %>% 
  group_by(COUNTY, Year) %>% 
  summarise(annual_mean_pm10 = mean(`Daily Mean PM10 Concentration`))
```

```{r}
no22017 <- read_csv("2017no2.csv")
no22018 <- read_csv("2018no2.csv")
no22019 <- read_csv("2019no2.csv")

no2 <- rbind(no22017, no22018, no22019) %>% 
  mutate(Year = substr(Date,nchar(Date)-3, nchar(Date))) %>% 
  group_by(COUNTY, Year) %>% 
  summarise(annual_mean_no2 = mean(`Daily Max 1-hour NO2 Concentration`))
```

```{r}
so22017 <- read_csv("2017so2.csv")
so22018 <- read_csv("2018so2.csv")
so22019 <- read_csv("2019so2.csv")

so2 <- rbind(so22017, so22018, so22019) %>% 
  mutate(Year = substr(Date,nchar(Date)-3, nchar(Date))) %>% 
  group_by(COUNTY, Year) %>% 
  summarise(annual_mean_so2 = mean(`Daily Max 1-hour SO2 Concentration`))
```

```{r}
pb2017 <- read_csv("2017pb.csv")
pb2018 <- read_csv("2018pb.csv")
pb2019 <- read_csv("2019pb.csv")

pb <- rbind(pb2017, pb2018, pb2019) %>% 
  mutate(Year = substr(Date,nchar(Date)-3, nchar(Date))) %>% 
  group_by(COUNTY, Year) %>% 
  summarise(annual_mean_pb = mean(`Daily Mean Pb Concentration`))
```

```{r}
ozone2017 <- read_csv("2017ozone.csv")
ozone2018 <- read_csv("2018ozone.csv")
ozone2019 <- read_csv("2019ozone.csv")

ozone <- rbind(ozone2017, ozone2018, ozone2019) %>% 
  mutate(Year = substr(Date,nchar(Date)-3, nchar(Date))) %>% 
  group_by(COUNTY, Year) %>% 
  summarise(annual_mean_ozone = mean(`Daily Max 8-hour Ozone Concentration`))
```

```{r}
pollutant2 <- left_join(ozone, pb, by = c("Year" = "Year", "COUNTY" = "COUNTY"))
pollutant3 <- left_join(pm25, pollutant2, by = c("Year" = "Year", "COUNTY" = "COUNTY"))
pollutant4 <- left_join(pollutant3, pm10, by = c("Year" = "Year", "COUNTY" = "COUNTY"))
pollutant5 <- left_join(pollutant4, co, by = c("Year" = "Year", "COUNTY" = "COUNTY"))
pollutant6 <- left_join(pollutant5, no2, by = c("Year" = "Year", "COUNTY" = "COUNTY"))
pollutant7 <- left_join(pollutant6, so2, by = c("Year" = "Year", "COUNTY" = "COUNTY"))
```

```{r}
data <- pollutant7 %>% 
  left_join(illness_data, by = c("COUNTY" = "County")) %>% 
  mutate(Year = as.double(Year))
```

```{r, eval=FALSE}
write.csv(data, "data.csv")
```

```{r}
data %>% 
  filter(!(COUNTY == "California")) %>% 
  ggplot(aes(x = annual_mean_pm25, y = asthma_er_avg)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Asthma ER visits")

data %>% 
  filter(!(COUNTY == "California")) %>% 
  filter(Year == 2017) %>% 
  ggplot(aes(x = annual_mean_ozone, y = asthma_er_avg)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Asthma and Ozone")

data %>% 
  filter(!(COUNTY == "California")) %>% 
  ggplot(aes(x = annual_mean_pm25, y = cancer_incidence_rate)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Cancer")
```


```{r}
california_deaths <- read_csv("2021-04-14_deaths_final_2014_2019_county_year_sup.csv")
```


```{r}
california_deaths_2017 <- california_deaths %>% 
  drop_na(Count) %>% 
  filter(Year > 2016,
         Strata_Name == "Total Population") %>% 
  group_by(County, Strata_Name, Cause, Cause_Desc, Year) %>% 
  summarize(deaths_per_year = mean(Count))
```

```{r}
california_deaths_causes <- california_deaths_2017 %>% 
  group_by(Cause_Desc) %>% 
  summarize(count = sum(deaths_per_year))
```

```{r}
california_deaths_2017 %>% 
  ungroup() %>% 
  dplyr::select(County, Cause_Desc, deaths_per_year, Year) %>% 
  pivot_wider(names_from = Cause_Desc, values_from = deaths_per_year)
```

```{r}
#data source: https://data.ca.gov/dataset/number-of-cancer-surgeries-volume-performed-in-california-hospitals
cancer_hospitals <- read_csv("Cancer_in_CA_hospitals.csv")
```

```{r}
cancer_hospitals_clean <- cancer_hospitals %>% 
  select(Year, County, Hospital, Surgery, `# of Cases (ICD 10)`) %>% 
  mutate(Surgery = str_glue("{Surgery}_Surgery_Ct",
                            Surgery = Surgery)) %>% 
  filter(Year > 2016,
         Hospital != "Statewide") %>% 
  group_by(Year, County, Surgery) %>% 
  summarize(Surgery_Ct = sum(`# of Cases (ICD 10)`)) %>% 
  spread(key = Surgery, value = Surgery_Ct)

```

```{r}
hpi <- read_csv("HPI2_MasterFile_2021-11-03.csv")
```

```{r}
#is.na is currently replacing NAs with 1s, need to address
hpi_county <- hpi %>% 
  group_by(County_Name) %>% 
  summarize(hpi2score = mean(is.na(hpi2score)),
            economic = mean(is.na(economic)),
            education = mean(is.na(education)), 
            housing = mean(is.na(housing)),
            healthcareaccess = mean(is.na(healthcareaccess)),
            neighborhood = mean(is.na(neighborhood)),
            pollution = mean(is.na(pollution)),
            transportation = mean(is.na(transportation)),
            social = mean(is.na(social)),
            insured = mean(is.na(insured)),
            uncrowded = mean(is.na(uncrowded)),
            homeownership = mean(is.na(homeownership)),
            automobile = mean(is.na(automobile)),
            commute = mean(is.na(commute)),
            inpreschool = mean(is.na(inpreschool)),
            inhighschool = mean(is.na(inhighschool)),
            bachelorsed = mean(is.na(bachelorsed)),
            employed = mean(is.na(employed)),
            abovepoverty = mean(is.na(abovepoverty)),
            income = mean(is.na(income)))
```


```{r}
data_deaths <- california_deaths_2017 %>% 
  filter(Cause == "ALL") %>% 
  right_join(data, by = c("County" = "COUNTY", "Year" = "Year")) %>% 
  left_join(cancer_hospitals_clean, by = c("County" = "County", "Year" = "Year"))
```

```{r}
write_csv(data_deaths, "data_deaths.csv")
```


